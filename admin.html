<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boss Timer Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <header class="bg-gray-800 text-white p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold flex items-center"><i data-feather="settings" class="mr-2"></i>Admin Panel</h1>
    <div id="adminUserDisplay"></div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-6">
    <!-- Server Management -->
    <section class="bg-white rounded-xl shadow p-4">
      <h2 class="text-xl font-semibold mb-4">Server Management</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newServerName" placeholder="Server Name" class="flex-1 px-3 py-2 border rounded"/>
        <input id="newServerPassword" placeholder="Password (or 'no password')" class="flex-1 px-3 py-2 border rounded"/>
        <button id="addServerBtn" class="px-4 py-2 bg-primary-500 text-white rounded">Add Server</button>
      </div>
      <ul id="serverList" class="space-y-2"></ul>
    </section>

    <!-- User Management -->
    <section class="bg-white rounded-xl shadow p-4">
      <h2 class="text-xl font-semibold mb-4">User Management</h2>
      <div class="flex space-x-2 mb-4">
        <input id="userEmail" placeholder="User Email" class="flex-1 px-3 py-2 border rounded"/>
        <button id="addAdminBtn" class="px-4 py-2 bg-green-500 text-white rounded">Grant Admin</button>
      </div>
      <ul id="adminList" class="space-y-2"></ul>
    </section>
  </main>

  <script>
    // ====== FIREBASE ======
    const firebaseConfig = {
      apiKey: "AIzaSyCcZa-fnSwdD36rB_DAR-SSfFlzH2fqcPc",
      authDomain: "lordninetimer.firebaseapp.com",
      projectId: "lordninetimer",
      storageBucket: "lordninetimer.firebasestorage.app",
      messagingSenderId: "462837939255",
      appId: "1:462837939255:web:dee141d630d5d9b94a53b2"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    feather.replace();

    // ====== SERVER MANAGEMENT ======
    const serverList = document.getElementById('serverList');
    const newServerName = document.getElementById('newServerName');
    const newServerPassword = document.getElementById('newServerPassword');

    async function fetchServers(){
      const snap = await db.ref('servers').once('value');
      const servers = snap.val() || {};
      serverList.innerHTML='';
      Object.entries(servers).forEach(([name, data])=>{
        const li = document.createElement('li');
        li.className='flex justify-between bg-gray-100 px-3 py-2 rounded';
        li.innerHTML=`<span>${name} - ${data.password || 'no password'}</span>
          <button class="bg-red-500 px-2 rounded text-white" onclick="deleteServer('${name}')">Delete</button>`;
        serverList.appendChild(li);
      });
    }

    document.getElementById('addServerBtn').addEventListener('click', async ()=>{
      const name = newServerName.value.trim();
      const pwd = newServerPassword.value.trim() || 'no password';
      if(!name) return alert('Server name required');
      await db.ref('servers/' + name).set({password: pwd});
      newServerName.value='';
      newServerPassword.value='';
      fetchServers();
    });

    async function deleteServer(name){
      if(confirm(`Delete server "${name}"?`)){
        await db.ref('servers/' + name).remove();
        fetchServers();
      }
    }

    fetchServers();

    // ====== USER MANAGEMENT ======
    const adminList = document.getElementById('adminList');
    async function fetchAdmins(){
      const snap = await db.ref('admins').once('value');
      const admins = snap.val() || {};
      adminList.innerHTML='';
      Object.keys(admins).forEach(email=>{
        const li = document.createElement('li');
        li.className='flex justify-between bg-gray-100 px-3 py-2 rounded';
        li.innerHTML=`<span>${email}</span>
          <button class="bg-red-500 px-2 rounded text-white" onclick="removeAdmin('${email}')">Remove</button>`;
        adminList.appendChild(li);
      });
    }

    document.getElementById('addAdminBtn').addEventListener('click', async ()=>{
      const email = document.getElementById('userEmail').value.trim();
      if(!email) return;
      await db.ref('admins/' + encodeURIComponent(email)).set(true);
      document.getElementById('userEmail').value='';
      fetchAdmins();
    });

    async function removeAdmin(email){
      if(confirm(`Remove admin "${email}"?`)){
        await db.ref('admins/' + encodeURIComponent(email)).remove();
        fetchAdmins();
      }
    }

    fetchAdmins();

    // ====== ADMIN HEADER DISPLAY ======
    const adminUserDisplay = document.getElementById('adminUserDisplay');
    const currentUser = JSON.parse(localStorage.getItem('bossTimerUser'));
    if(currentUser) adminUserDisplay.textContent = `${currentUser.playerName} (${currentUser.server})`;
  </script>
</body>
</html>