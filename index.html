<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BossTime Pro Timer</title>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">

<!-- Tailwind & Feather Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: {500:'#3b82f6',600:'#2563eb'},
        secondary: {500:'#10b981',600:'#059669'}
      },
      fontFamily: {inter:['Inter','sans-serif']}
    }
  }
};
</script>

<style>
body.dark {background-color:#111827;color:#f3f4f6;}
body.light {background-color:#f9fafb;color:#111827;}
.timer-card {transition: all 0.3s ease;}
.timer-card.running {box-shadow: 0 0 15px rgba(59,130,246,0.5);}
.timer-card.warning {box-shadow:0 0 15px rgba(234,179,8,0.5);}
.timer-card.expired {box-shadow:0 0 15px rgba(239,68,68,0.5);}
.timer-card.today {box-shadow:0 0 15px rgba(16,185,129,0.5);}
.table-container {overflow-x:auto;-webkit-overflow-scrolling:touch;}
.boss-column {position:sticky;left:0;z-index:10;background:white;box-shadow:2px 0 5px rgba(0,0,0,0.1);}
.status-active {background-color:#10B981;color:white;}
.status-upcoming {background-color:#F59E0B;color:#1F2937;}
.status-scheduled {background-color:#3B82F6;color:white;}
.status-empty {background-color:#F3F4F6;color:#6B7280;}
.cell-hover:hover {transform: scale(1.02);transition: transform 0.2s ease;z-index:5;}
</style>
</head>

<body class="dark font-inter">
<div class="min-h-screen bg-gray-900 text-gray-100">

<!-- Header -->
<header class="bg-gray-800 shadow-lg">
<div class="container mx-auto px-4 py-4 flex justify-between items-center">
  <div class="flex items-center space-x-4">
    <i data-feather="clock" class="text-primary-500"></i>
    <h1 class="text-2xl font-bold">BossTime Pro</h1>
  </div>
  <div class="flex items-center space-x-4">
    <button id="themeToggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition">
      <i data-feather="moon"></i>
    </button>
    <div class="flex items-center space-x-2 bg-gray-700 px-3 py-1 rounded-full">
      <i data-feather="user" class="w-4 h-4"></i>
      <span id="userDisplay">Guest</span>
    </div>
  </div>
</div>
</header>

<!-- User Modal -->
<div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
<div class="bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md">
<h3 class="text-xl font-bold mb-4">Set Your Information</h3>
<div class="space-y-4">
  <div>
    <label class="block text-sm font-medium mb-1">Player Name</label>
    <input id="playerNameInput" type="text" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"/>
  </div>
  <div>
    <label class="block text-sm font-medium mb-1">Guild</label>
    <input id="guildInput" type="text" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"/>
  </div>
  <div>
    <label class="block text-sm font-medium mb-1">Server</label>
    <select id="serverSelect" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
      <option>Server1</option>
      <option>Server2</option>
      <option>Server3</option>
    </select>
  </div>
  <div class="flex justify-end space-x-3 pt-4">
    <button id="cancelUserBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">Cancel</button>
    <button id="saveUserBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 rounded-lg transition">Save</button>
  </div>
</div>
</div>
</div>

<!-- Main Content -->
<main class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- Manual Timers -->
    <section class="bg-gray-800 rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold flex items-center">
          <i data-feather="plus-circle" class="mr-2 text-primary-500"></i>
          Manual Timers
        </h2>
        <button id="stopAllManual" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 rounded-lg text-sm font-medium transition">Stop All</button>
      </div>

      <!-- Add Manual Timer -->
      <div class="space-y-4 mb-6">
        <div class="flex flex-col md:flex-row gap-3">
          <input id="manualBossName" type="text" placeholder="Boss Name" class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"/>
          <input id="manualHours" type="number" placeholder="Hours" min="1" class="w-24 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"/>
          <button id="addManualTimer" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 rounded-lg font-medium transition">Add Timer</button>
        </div>
      </div>

      <!-- Manual Timers List -->
      <div id="manualTimersContainer" class="space-y-4"></div>
    </section>

    <!-- Scheduled Timers -->
    <section class="bg-gray-800 rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold flex items-center">
          <i data-feather="calendar" class="mr-2 text-secondary-500"></i>
          Scheduled Bosses
        </h2>
        <button id="addScheduledBtn" class="px-4 py-2 bg-secondary-500 hover:bg-secondary-600 rounded-lg text-sm font-medium transition">Add Boss</button>
      </div>

      <!-- Add Scheduled Boss Form -->
      <div id="scheduledBossForm" class="hidden space-y-4 mb-6">
        <div class="flex flex-col md:flex-row gap-3">
          <input id="scheduledBossName" type="text" placeholder="Boss Name" class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-secondary-500 focus:border-transparent"/>
          <input id="scheduledTime" type="text" placeholder="mon 12:30, tue 15:00" class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-secondary-500 focus:border-transparent"/>
          <button id="saveScheduledBoss" class="px-4 py-2 bg-secondary-500 hover:bg-secondary-600 rounded-lg font-medium transition">Save</button>
        </div>
      </div>

      <!-- Scheduled Boss Cards -->
      <div id="scheduledTimersContainer" class="space-y-4"></div>
    </section>
  </div>
</main>

<!-- Firebase Config -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCcZa-fnSwdD36rB_DAR-SSfFlzH2fqcPc",
  authDomain: "lordninetimer.firebaseapp.com",
  projectId: "lordninetimer",
  storageBucket: "lordninetimer.firebasestorage.app",
  messagingSenderId: "462837939255",
  appId: "1:462837939255:web:dee141d630d5d9b94a53b2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
// Theme toggle
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  document.body.classList.toggle('light');
  themeToggle.innerHTML = document.body.classList.contains('dark') ? feather.icons['moon'].toSvg() : feather.icons['sun'].toSvg();
});

// User modal
const userModal = document.getElementById('userModal');
const userDisplay = document.getElementById('userDisplay');
let userInfo = JSON.parse(localStorage.getItem('bossTimerUser')) || null;
if(!userInfo) userModal.classList.remove('hidden'); else userDisplay.textContent = userInfo.playerName;

document.getElementById('saveUserBtn').addEventListener('click', ()=>{
  const playerName = document.getElementById('playerNameInput').value.trim();
  const guild = document.getElementById('guildInput').value.trim();
  const server = document.getElementById('serverSelect').value;
  if(playerName && guild && server){
    userInfo={playerName,guild,server};
    localStorage.setItem('bossTimerUser',JSON.stringify(userInfo));
    userDisplay.textContent=playerName;
    userModal.classList.add('hidden');
  } else alert('Please fill all fields');
});

document.getElementById('cancelUserBtn').addEventListener('click',()=>{
  if(!userInfo) alert('You must set your player information to use this app');
  else userModal.classList.add('hidden');
});

// Feather icons
feather.replace();
</script>

<script>
// ---------- MANUAL TIMERS ----------
let manualTimers = [];

function renderManualTimers(){
  const container = document.getElementById('manualTimersContainer');
  container.innerHTML = '';
  manualTimers.forEach((t,index)=>{
    const card = document.createElement('div');
    card.className='timer-card bg-gray-700 rounded-lg p-4 border-l-4 border-primary-500';
    card.innerHTML=`
      <div class="flex justify-between items-start">
        <div>
          <h3 class="font-bold text-lg">${t.name}</h3>
          <p class="text-sm text-gray-400">${t.running?'Running':'Stopped'} - Miss: 0</p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-mono font-bold" id="manualTimer${index}">${formatTime(t.remaining)}</div>
        </div>
      </div>
      <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-600">
        <p class="text-xs text-gray-400">Last: ${t.last || 'N/A'}</p>
        <div class="flex space-x-2">
          <button class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs font-medium transition" onclick="restartManual(${index})">Restart</button>
          <button class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs font-medium transition" onclick="stopManual(${index})">Stop</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// Add Manual Timer
document.getElementById('addManualTimer').addEventListener('click',()=>{
  const name = document.getElementById('manualBossName').value.trim();
  const hours = parseInt(document.getElementById('manualHours').value);
  if(name && hours>0){
    manualTimers.push({name,hours,remaining:hours*3600,running:false,last:null,interval:null});
    renderManualTimers();
  }
});

// Format seconds to hh:mm:ss
function formatTime(sec){
  const h=Math.floor(sec/3600).toString().padStart(2,'0');
  const m=Math.floor((sec%3600)/60).toString().padStart(2,'0');
  const s=Math.floor(sec%60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// Restart Manual Timer
function restartManual(index){
  const t = manualTimers[index];
  if(t.interval) clearInterval(t.interval);
  t.running=true;
  t.interval=setInterval(()=>{
    if(t.remaining>0){
      t.remaining--;
      document.getElementById(`manualTimer${index}`).textContent=formatTime(t.remaining);
      // Notification 10 minutes before
      if(t.remaining===600) notifyUser(`${t.name} ends in 10 minutes`);
    } else {
      clearInterval(t.interval);
      t.running=false;
    }
  },1000);
  renderManualTimers();
}

// Stop Manual Timer
function stopManual(index){
  const t = manualTimers[index];
  if(t.interval) clearInterval(t.interval);
  t.running=false;
  renderManualTimers();
}

// Stop All Manual Timers
document.getElementById('stopAllManual').addEventListener('click',()=>{
  manualTimers.forEach(t=>{ if(t.interval) clearInterval(t.interval); t.running=false; });
  renderManualTimers();
});

// ---------- SCHEDULED TIMERS ----------
let scheduledTimers = [];

function loadScheduledTimers(){
  if(!userInfo) return;
  db.collection('timers').where('server','==',userInfo.server).get().then(snapshot=>{
    scheduledTimers=[];
    snapshot.forEach(doc=>{
      const data = doc.data();
      scheduledTimers.push({...data,id:doc.id});
    });
    renderScheduledTimers();
  });
}

function renderScheduledTimers(){
  const container = document.getElementById('scheduledTimersContainer');
  container.innerHTML='';
  scheduledTimers.forEach((t,index)=>{
    const card=document.createElement('div');
    card.className='timer-card today bg-gray-700 rounded-lg p-4 border-l-4 border-secondary-500';
    const times=t.times.join(', '); // merged times
    card.innerHTML=`
      <div class="flex justify-between items-start">
        <div>
          <h3 class="font-bold text-lg">${t.name}</h3>
          <p class="text-sm text-gray-400">${times}</p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-mono font-bold">${times}</div>
        </div>
      </div>
      <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-600">
        <p class="text-xs text-gray-400">Guild Owner: ${t.guild}</p>
      </div>
    `;
    container.appendChild(card);
  });
}

// Notification function
function notifyUser(msg){
  if(Notification.permission==='granted'){
    new Notification('BossTime Pro', {body:msg});
  }
}
</script>

<script>
// ---------- ADD/SAVE SCHEDULED BOSS ----------
document.getElementById('addScheduledBtn').addEventListener('click',()=>{
  document.getElementById('scheduledBossForm').classList.toggle('hidden');
});

document.getElementById('saveScheduledBoss').addEventListener('click',()=>{
  const name = document.getElementById('scheduledBossName').value.trim();
  const timesRaw = document.getElementById('scheduledTime').value.trim();
  if(!name || !timesRaw) return alert('Enter boss name and times (e.g., mon 12:30, tue 15:00)');
  const times = timesRaw.split(',').map(t=>t.trim());
  
  // Save to Firestore
  db.collection('timers').add({
    name,
    times,
    guild: userInfo.guild,
    server: userInfo.server
  }).then(()=>{
    addActivity(`${userInfo.playerName} added scheduled boss ${name}`);
    loadScheduledTimers();
    document.getElementById('scheduledBossForm').classList.add('hidden');
    document.getElementById('scheduledBossName').value='';
    document.getElementById('scheduledTime').value='';
  }).catch(err=>console.error(err));
});

// ---------- ACTIVITY FEED ----------
function addActivity(msg){
  const activityFeed=document.getElementById('activityFeed');
  const item=document.createElement('div');
  item.className='flex items-center justify-between p-2 hover:bg-gray-600 rounded transition';
  item.innerHTML=`
    <div class="flex items-center space-x-3">
      <div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center">
        <i data-feather="user" class="w-4 h-4"></i>
      </div>
      <div>
        <p class="text-sm font-medium">${userInfo.playerName} [${userInfo.guild}]</p>
        <p class="text-xs text-gray-400">${msg}</p>
      </div>
    </div>
    <span class="text-xs text-gray-400">just now</span>
  `;
  activityFeed.insertBefore(item, activityFeed.firstChild);
  feather.replace();
}

// ---------- LOCALSTORAGE PERSISTENCE ----------
function saveTimersToLocal(){
  localStorage.setItem('manualTimers', JSON.stringify(manualTimers));
  localStorage.setItem('scheduledTimers', JSON.stringify(scheduledTimers));
}

function loadTimersFromLocal(){
  const mt = JSON.parse(localStorage.getItem('manualTimers'));
  if(mt) manualTimers=mt;
  const st = JSON.parse(localStorage.getItem('scheduledTimers'));
  if(st) scheduledTimers=st;
  renderManualTimers();
  renderScheduledTimers();
}

// Load stored timers
loadTimersFromLocal();

// Save timers every 30 sec
setInterval(saveTimersToLocal, 30000);

// Request notification permission
if(Notification.permission!=='granted'){
  Notification.requestPermission();
}

// Load scheduled timers from Firestore on login
if(userInfo){
  loadScheduledTimers();
}
</script>

<!-- Add server selection to user modal -->
<div>
  <label class="block text-sm font-medium mb-1">Server</label>
  <select id="serverSelect" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
    <option value="">Select Server</option>
    <option value="Server1">Server1</option>
    <option value="Server2">Server2</option>
    <option value="Server3">Server3</option>
  </select>
</div>

<script>
// ---------- SERVER PASSWORD HANDLING ----------
let serverPasswords = {}; // Loaded from Firestore
let enteredPasswords = {}; // Keeps track of session passwords

function checkServerPassword(server){
  if(!serverPasswords[server] || serverPasswords[server]==='') return true; // no password required
  if(enteredPasswords[server]) return true; // already entered
  const pw = prompt(`Enter password for ${server}`);
  if(pw===serverPasswords[server]){
    enteredPasswords[server]=true;
    return true;
  } else {
    alert('Incorrect password');
    return false;
  }
}

// Example usage before starting manual timer
function startManualTimer(index){
  if(!checkServerPassword(userInfo.server)) return;
  restartManual(index);
}

// ---------- ADMIN FEATURES ----------
let admins = []; // list of admin player names

function isAdmin(playerName){
  return admins.includes(playerName) || playerName==='TempTier'; // Temp admin example
}

// Example: show admin header
if(isAdmin(userInfo?.playerName)){
  const adminHeader = document.createElement('div');
  adminHeader.className='text-sm text-red-400 font-bold ml-4';
  adminHeader.textContent='Admin';
  document.querySelector('header .flex.items-center.space-x-4').appendChild(adminHeader);
}

// Admin can set/update server passwords
function setServerPassword(server,password){
  if(!isAdmin(userInfo.playerName)) return;
  db.collection('servers').doc(server).set({password},{merge:true});
}

// ---------- SEND BUTTON PLACEHOLDER ----------
function sendTimer(index){
  // TODO: Implement later
  alert(`Send button clicked for timer index ${index}`);
}
</script>

</body>
</html>
