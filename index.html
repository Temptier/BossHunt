<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BossTime Pro Timer.1</title>

  <!-- Tailwind & Feather -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {500:'#3b82f6',600:'#2563eb'},
            secondary: {500:'#10b981',600:'#059669'},
          },
        },
      },
    };
  </script>

  <style>
    body.dark { background-color:#111827; color:#f3f4f6; }
    body.light { background-color:#f9fafb; color:#111827; }
    .timer-card { transition: all 0.3s ease; }
    .timer-card.running { box-shadow: 0 0 15px rgba(59,130,246,0.5);}
    .timer-card.warning { box-shadow: 0 0 15px rgba(234,179,8,0.5);}
    .timer-card.expired { box-shadow: 0 0 15px rgba(239,68,68,0.5);}
    .timer-card.today { box-shadow: 0 0 15px rgba(16,185,129,0.5);}
  </style>
</head>

<body class="dark">
<div class="min-h-screen bg-gray-900 text-gray-100">

<!-- Header -->
<header class="bg-gray-800 shadow-lg text-white">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <div class="flex items-center space-x-4">
      <i data-feather="clock" class="text-primary-500"></i>
      <h1 class="text-2xl font-bold">BossTime Pro</h1>
    </div>

    <div class="flex items-center space-x-4">
      <button id="themeToggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition">
        <i data-feather="moon"></i>
      </button>

      <div class="flex items-center space-x-2 bg-gray-700 px-3 py-1 rounded-full">
        <i data-feather="user" class="w-4 h-4"></i>
        <span id="userDisplay">Guest</span>
      </div>

      <!-- Admin button -->
      <button id="adminBtn" class="hidden px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-sm font-medium">
        Admin Panel
      </button>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="container mx-auto px-4 py-8">

<!-- Manual Timers Section -->
<section class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold flex items-center">
      <i data-feather="plus-circle" class="mr-2 text-primary-500"></i>
      Manual Timers
    </h2>
    <button id="restartAllManual" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 rounded-lg text-sm font-medium transition">
      Restart All
    </button>
  </div>

  <!-- Add Manual Timer -->
  <div class="space-y-4 mb-6">
    <div class="flex flex-col md:flex-row gap-3">
      <input id="manualBossName" type="text" placeholder="Boss Name" class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"/>
      <input id="manualHours" type="number" placeholder="Hours" min="1" class="w-24 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"/>
      <button id="addManualTimer" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 rounded-lg font-medium transition">Add Timer</button>
    </div>
  </div>

  <!-- Manual Timers List -->
  <div id="manualTimersContainer" class="space-y-4"></div>
</section>

<!-- Scheduled Timers Section -->
<section class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold flex items-center">
      <i data-feather="calendar" class="mr-2 text-secondary-500"></i>
      Scheduled Bosses
    </h2>
    <button id="addScheduledBtn" class="px-4 py-2 bg-secondary-500 hover:bg-secondary-600 rounded-lg text-sm font-medium transition">
      Add Boss
    </button>
  </div>

  <!-- Add Scheduled Boss Form -->
  <div id="scheduledBossForm" class="hidden space-y-4 mb-6">
    <div class="flex flex-col md:flex-row gap-3">
      <input id="scheduledBossName" type="text" placeholder="Boss Name" class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"/>
      <input id="scheduledTime" type="text" placeholder="Mon 12:30, Thu 19:00" class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"/>
      <button id="saveScheduledBoss" class="px-4 py-2 bg-secondary-500 hover:bg-secondary-600 rounded-lg font-medium transition">Save</button>
    </div>
  </div>

  <div id="scheduledTimersContainer" class="space-y-4"></div>
</section>

<!-- User Modal -->
<div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md">
    <h3 class="text-xl font-bold mb-4">Set Your Information</h3>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Player Name</label>
        <input id="playerNameInput" type="text" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"/>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Guild</label>
        <input id="guildInput" type="text" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"/>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Server</label>
        <select id="serverSelect" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"></select>
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button id="cancelUserBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
        <button id="saveUserBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 rounded-lg">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
feather.replace();

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCcZa-fnSwdD36rB_DAR-SSfFlzH2fqcPc",
  authDomain: "lordninetimer.firebaseapp.com",
  projectId: "lordninetimer",
  storageBucket: "lordninetimer.firebasestorage.app",
  messagingSenderId: "462837939255",
  appId: "1:462837939255:web:dee141d630d5d9b94a53b2"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====== THEME TOGGLE ======
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  document.body.classList.toggle('light');
  themeToggle.innerHTML = document.body.classList.contains('dark') ? feather.icons['moon'].toSvg() : feather.icons['sun'].toSvg();
});

// ====== USER INFO ======
const userModal = document.getElementById('userModal');
const userDisplay = document.getElementById('userDisplay');
const playerNameInput = document.getElementById('playerNameInput');
const guildInput = document.getElementById('guildInput');
const serverSelect = document.getElementById('serverSelect');

let userInfo = JSON.parse(localStorage.getItem('bossTimerUser')) || null;

// Load servers for selection
db.ref('servers').on('value', snap => {
  serverSelect.innerHTML = '';
  if(snap.exists()){
    Object.keys(snap.val()).forEach(name => {
      const option = document.createElement('option');
      option.value = name; option.textContent = name;
      serverSelect.appendChild(option);
    });
  }
});

if(!userInfo){
  userModal.classList.remove('hidden');
}else{
  userDisplay.textContent = userInfo.playerName;
}

// Save user info
document.getElementById('saveUserBtn').addEventListener('click', ()=>{
  const playerName = playerNameInput.value.trim();
  const guild = guildInput.value.trim();
  const server = serverSelect.value;

  if(playerName && guild && server){
    userInfo = {playerName, guild, server};
    localStorage.setItem('bossTimerUser', JSON.stringify(userInfo));
    userDisplay.textContent = playerName;
    userModal.classList.add('hidden');
  }else{
    alert('Please fill all fields.');
  }
});

document.getElementById('cancelUserBtn').addEventListener('click', ()=>{
  if(!userInfo){
    alert('You must set your info.');
    return;
  }
  userModal.classList.add('hidden');
});

// ====== ADMIN BUTTON ======
const adminBtn = document.getElementById('adminBtn');
const adminUsers = ['AdminPlayerName']; // replace with real admin player names
if(userInfo && adminUsers.includes(userInfo.playerName)){
  adminBtn.classList.remove('hidden');
  adminBtn.addEventListener('click', () => window.open('admin.html', '_blank'));
}

// ====== SERVER PASSWORD MODAL ======
const serverPasswordModal = document.getElementById('serverPasswordModal');
const serverPasswordInput = document.getElementById('serverPasswordInput');
let currentTimerAction = null;
let currentServer = null;

function isServerVerified(server){
  const verified = JSON.parse(sessionStorage.getItem('verifiedServers')) || {};
  return verified[server];
}

function verifyServerPassword(server, action){
  if(isServerVerified(server)){
    action(); return;
  }
  currentTimerAction = action;
  currentServer = server;
  serverPasswordInput.value='';
  serverPasswordModal.classList.remove('hidden');
}

document.getElementById('cancelPasswordBtn').addEventListener('click', ()=>{
  serverPasswordModal.classList.add('hidden');
});

document.getElementById('submitPasswordBtn').addEventListener('click', ()=>{
  const password = serverPasswordInput.value;
  if(!currentServer || !currentTimerAction) return;

  db.ref('servers/' + currentServer + '/password').once('value').then(snap=>{
    const realPassword = snap.val() || '';
    if(realPassword === 'no password' || password === realPassword){
      const verified = JSON.parse(sessionStorage.getItem('verifiedServers')) || {};
      verified[currentServer] = true;
      sessionStorage.setItem('verifiedServers', JSON.stringify(verified));
      serverPasswordModal.classList.add('hidden');
      currentTimerAction();
    }else{
      alert('Incorrect password!');
    }
  });
});

// ====== MANUAL TIMERS ======
let manualTimers = {};
const manualTimersContainer = document.getElementById('manualTimersContainer');

function renderManualTimers(){
  manualTimersContainer.innerHTML = '';
  Object.keys(manualTimers).forEach(key=>{
    const t = manualTimers[key];
    const div = document.createElement('div');
    div.className = 'timer-card bg-gray-700 rounded-lg p-4 border-l-4 border-primary-500 flex justify-between items-center';
    div.innerHTML=`
      <div>
        <h3 class="font-bold text-lg">${t.name}</h3>
        <p class="text-sm text-gray-400">${t.status} - Miss: ${t.miss || 0}</p>
      </div>
      <div class="space-x-2">
        <button class="restartBtn px-3 py-1 bg-primary-500 hover:bg-primary-600 rounded text-xs font-medium">Restart</button>
        <button class="stopBtn px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs font-medium">Stop</button>
        <button class="sendBtn px-3 py-1 bg-secondary-500 hover:bg-secondary-600 rounded text-xs font-medium">Send</button>
      </div>
    `;
    // Restart
    div.querySelector('.restartBtn').addEventListener('click', ()=>{
      verifyServerPassword(userInfo.server, ()=>{
        t.remaining = t.duration;
        t.status='running';
        startManualTimer(key);
        renderManualTimers();
      });
    });
    // Stop
    div.querySelector('.stopBtn').addEventListener('click', ()=>{
      t.status='stopped';
      clearInterval(t.intervalId);
      renderManualTimers();
    });
    // Send
    div.querySelector('.sendBtn').addEventListener('click', ()=>{
      verifyServerPassword(userInfo.server, ()=>{
        alert(`Send manual timer info: ${t.name}`);
      });
    });
    manualTimersContainer.appendChild(div);
  });
}

document.getElementById('addManualTimer').addEventListener('click', ()=>{
  const name = document.getElementById('manualBossName').value.trim();
  const hours = parseInt(document.getElementById('manualHours').value.trim());
  if(!name || !hours){ alert('Enter name and hours'); return;}
  const key = 't'+Date.now();
  manualTimers[key] = {name, duration: hours*3600, remaining: hours*3600, status:'stopped'};
  renderManualTimers();
});

document.getElementById('restartAllManual').addEventListener('click', ()=>{
  verifyServerPassword(userInfo.server, ()=>{
    Object.keys(manualTimers).forEach(key=>{
      manualTimers[key].remaining=manualTimers[key].duration;
      manualTimers[key].status='running';
      startManualTimer(key);
    });
    renderManualTimers();
  });
});

function startManualTimer(key){
  const t = manualTimers[key];
  clearInterval(t.intervalId);
  t.intervalId = setInterval(()=>{
    if(t.remaining>0){
      t.remaining--;
      if(t.remaining===600){ alert(`10 minutes left for ${t.name}`); }
    }else{
      t.status='expired';
      clearInterval(t.intervalId);
      alert(`${t.name} timer expired!`);
    }
    renderManualTimers();
  },1000);
}

// ====== SCHEDULED TIMERS ======
const scheduledTimersContainer = document.getElementById('scheduledTimersContainer');

db.ref('servers').on('value', snap=>{
  scheduledTimersContainer.innerHTML='';
  if(!snap.exists()) return;
  const servers = snap.val();
  Object.keys(servers).forEach(serverName=>{
    if(!servers[serverName].scheduledTimers) return;
    const timers = servers[serverName].scheduledTimers;
    Object.keys(timers).forEach(key=>{
      const t = timers[key];
      const schedules = Array.isArray(t.schedules)?t.schedules:[t.schedules];
      const div = document.createElement('div');
      div.className='timer-card today bg-gray-700 rounded-lg p-4 border-l-4 border-secondary-500 flex justify-between items-center';
      div.innerHTML=`
        <div>
          <h3 class="font-bold text-lg">${t.bossName}</h3>
          <p class="text-sm text-gray-400">Next: ${schedules.join(', ')}</p>
        </div>
        <div>
          <button class="sendBtn px-3 py-1 bg-secondary-500 hover:bg-secondary-600 rounded text-xs font-medium">Send</button>
        </div>
      `;
      div.querySelector('.sendBtn').addEventListener('click', ()=>{
        verifyServerPassword(userInfo.server, ()=>{
          alert(`Send scheduled info for ${t.bossName}`);
        });
      });
      scheduledTimersContainer.appendChild(div);
    });
  });
});
</script>
</body>
</html>